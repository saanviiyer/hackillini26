<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sandozer ‚Äî Mission Control</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Barlow:wght@400;600;700;900&family=DM+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f5f0e8;
            --map-bg: #ede8dc;
            --grid-line: #d8d0be;
            --black: #1a1a1a;
            --yellow: #f5c800;
            --yellow-dark: #d4a800;
            --yellow-pale: #fdf6cc;
            --green: #2d7a3a;
            --green-light: #4aab5c;
            --beige: #f5f0e8;
            --beige-dark: #e0d5be;
            --muted: #7a7060;
            --cell: 44px;
            --danger: #c0392b;
            --danger-bg: #fde8e6;
            --warn: #e67e22;
            --warn-bg: #fdf0e0;
            --cloudflare-orange: #f38020;
            /* Updated Brand Color */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            font-family: 'Barlow', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06);
            padding: 40px 36px;
            width: 680px;
            max-width: calc(100vw - 32px);
            position: relative;
        }

        .btn-pill.cloudflare {
            /* Renamed from .actian */
            background: #fff;
            border: 2px solid var(--cloudflare-orange);
            color: var(--cloudflare-orange);
            box-shadow: 0 2px 10px rgba(243, 128, 32, 0.15);
        }

        .btn-pill.cloudflare:hover {
            background: #fff9f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(243, 128, 32, 0.25);
        }

        .cloudflare-badge {
            /* Renamed from .actian-badge */
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            color: var(--cloudflare-orange);
            border: 1px solid var(--cloudflare-orange);
            background: #fff9f5;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0.05em;
            margin-top: 16px;
        }

        .cloudflare-toggle-row {
            /* Renamed from .actian-toggle-row */
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--cloudflare-orange);
            background: #fff9f5;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #ffe8d9;
        }

        .cloudflare-toggle-row input {
            cursor: pointer;
            accent-color: var(--cloudflare-orange);
        }

        .card-tag {
            position: absolute;
            top: 16px;
            right: 20px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--muted);
            letter-spacing: 0.1em;
            background: var(--beige);
            padding: 3px 10px;
            border-radius: 20px;
            border: 1px solid var(--beige-dark);
        }

        .info-btn {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--beige-dark);
            background: #fff;
            color: var(--muted);
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .info-btn:hover {
            border-color: var(--black);
            color: var(--black);
        }

        .btn-pill {
            background: var(--yellow);
            border: none;
            border-radius: 40px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            padding: 12px 36px;
            cursor: pointer;
            color: var(--black);
            letter-spacing: 0.06em;
            transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
            box-shadow: 0 2px 12px rgba(245, 200, 0, 0.3);
        }

        .btn-pill:hover {
            background: var(--yellow-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 200, 0, 0.4);
        }

        .btn-pill:active {
            transform: translateY(0);
        }

        .btn-pill.outline {
            background: transparent;
            border: 2.5px solid var(--yellow);
            color: var(--black);
            box-shadow: none;
        }

        .btn-pill.outline:hover {
            background: var(--yellow-pale);
        }

        .btn-pill.danger {
            background: var(--danger);
            color: #fff;
            box-shadow: 0 2px 12px rgba(192, 57, 43, 0.3);
        }

        .btn-pill.danger:hover {
            background: #a93226;
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);
        }

        .btn-pill.actian {
            background: #fff;
            border: 2px solid var(--actian-blue);
            color: var(--actian-blue);
            box-shadow: 0 2px 10px rgba(0, 82, 204, 0.15);
        }

        .btn-pill.actian:hover {
            background: #f0f5ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 82, 204, 0.25);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 28px 28px;
            opacity: 0.45;
            pointer-events: none;
            z-index: -1;
        }

        /* SPLASH */
        #screen-splash .card {
            width: 720px;
            text-align: center;
            padding: 56px 48px;
        }

        .splash-pre {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem;
            letter-spacing: 0.2em;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .splash-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 900;
            color: var(--black);
            line-height: 1.1;
        }

        .splash-title .accent {
            color: var(--yellow-dark);
        }

        .splash-sub {
            font-family: 'Orbitron', monospace;
            font-size: 0.95rem;
            font-weight: 400;
            color: var(--muted);
            letter-spacing: 0.2em;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .splash-divider {
            width: 80px;
            height: 3px;
            background: var(--yellow);
            margin: 28px auto;
            border-radius: 2px;
        }

        .splash-about-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 36px;
            text-align: left;
        }

        .about-box {
            background: var(--beige);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--beige-dark);
        }

        .about-box h3 {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .about-box p,
        .about-box li {
            font-size: 0.85rem;
            color: var(--black);
            line-height: 1.6;
        }

        .about-box ul {
            padding-left: 16px;
        }

        .about-box li {
            margin-bottom: 4px;
        }

        .jd-logo {
            display: inline-block;
            background: var(--black);
            color: var(--yellow);
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 1.1rem;
            padding: 8px 16px;
            border-radius: 8px;
            letter-spacing: 0.06em;
            margin-top: 6px;
        }

        .actian-badge {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            color: var(--actian-blue);
            border: 1px solid var(--actian-blue);
            background: #f0f5ff;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0.05em;
            margin-top: 16px;
        }

        /* VOICE PILL */
        .voice-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            padding: 4px 11px;
            border-radius: 20px;
            border: 1px solid var(--beige-dark);
            color: var(--muted);
            background: var(--beige);
            transition: all 0.2s;
        }

        .voice-pill.active {
            border-color: #f5c800;
            color: #8a6800;
            background: #fdf6cc;
        }

        .voice-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: currentColor;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.4
            }
        }

        .voice-pill.active .voice-dot {
            animation: pulse 0.9s ease-in-out infinite;
        }

        /* MODE SELECT */
        #screen-mode .card {
            text-align: center;
            padding: 56px 48px;
        }

        .mode-question {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 32px;
            letter-spacing: 0.04em;
        }

        .mode-btns {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: var(--yellow-pale);
            border: 2.5px solid var(--yellow);
            border-radius: 40px;
            font-family: 'Orbitron', monospace;
            font-size: 0.95rem;
            font-weight: 700;
            padding: 14px 44px;
            cursor: pointer;
            color: var(--black);
            letter-spacing: 0.06em;
            transition: all 0.15s;
        }

        .mode-btn:hover,
        .mode-btn.selected {
            background: var(--yellow);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 200, 0, 0.35);
        }

        /* OBSERVE & TEST & RESULT LAYOUT */
        #screen-observe .card,
        #screen-test .card,
        #screen-result .card {
            width: 960px;
            padding: 28px;
        }

        .observe-layout,
        .test-layout,
        .result-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 28px;
            align-items: start;
        }

        .screen-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--black);
            margin-bottom: 16px;
            letter-spacing: 0.02em;
        }

        /* ‚îÄ‚îÄ RESPONSIVE / MOBILE ‚îÄ‚îÄ */
        @media (max-width: 700px) {
            body {
                overflow-y: auto;
                align-items: flex-start;
            }

            .screen {
                position: relative;
                inset: auto;
                min-height: 100vh;
                align-items: flex-start;
                padding: 12px 0 80px;
            }

            .card {
                padding: 20px 16px;
                border-radius: 12px;
                width: 100% !important;
            }

            .observe-layout,
            .test-layout,
            .result-layout {
                grid-template-columns: 1fr !important;
                gap: 18px;
            }

            .mini-grid-wrap {
                display: flex;
                justify-content: center;
                width: 100%;
            }

            .mini-grid {
                transform-origin: top center;
            }

            .mode-btns {
                flex-direction: column;
                align-items: center;
            }

            .mode-btn {
                width: 100%;
                max-width: 260px;
            }

            #mic-fab {
                bottom: 12px;
                left: 12px;
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .mini-grid {
                transform: scale(0.85);
                transform-origin: top center;
                margin-bottom: -24px;
            }
        }

        .mini-grid-wrap {
            position: relative;
            flex-shrink: 0;
        }

        .mini-grid {
            border-collapse: separate;
            border-spacing: 3px;
            background: var(--map-bg);
            padding: 6px;
            border-radius: 10px;
            border: 2px solid var(--beige-dark);
        }

        .mini-cell {
            width: var(--cell);
            height: var(--cell);
            background: rgba(245, 240, 232, 0.9);
            border-radius: 4px;
            border: 1px solid #ccc5b0;
            position: relative;
        }

        .mini-cell .mc-label {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 0.42rem;
            font-family: 'DM Mono', monospace;
            color: #bbb0a0;
        }

        .mini-svg {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 3;
        }

        .mini-robot {
            position: absolute;
            z-index: 5;
            pointer-events: none;
            transform: translate(-50%, -50%);
            transition: left 0.7s cubic-bezier(0.4, 0, 0.2, 1), top 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mini-robot-dot {
            width: 20px;
            height: 20px;
            background: var(--black);
            border-radius: 6px;
            border: 3px solid var(--yellow);
            box-shadow: 0 0 12px rgba(245, 200, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-robot-dot svg {
            width: 11px;
            height: 11px;
            fill: var(--yellow);
        }

        .pulse {
            animation: pulse 1.2s ease-in-out infinite;
        }

        .obs-panel,
        .test-panel,
        .result-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .obs-row,
        .result-row {
            display: flex;
            align-items: baseline;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--beige-dark);
        }

        .obs-row:last-child,
        .result-row:last-child {
            border-bottom: none;
        }

        .obs-label,
        .result-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem;
            color: var(--muted);
            letter-spacing: 0.08em;
            min-width: 130px;
            flex-shrink: 0;
        }

        .obs-val,
        .result-val {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.9rem;
            color: var(--black);
            font-weight: 500;
        }

        .obs-val.highlight,
        .result-val.tilt {
            color: var(--yellow-dark);
            font-weight: 700;
        }

        .terrain-row,
        .result-terrain {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .terrain-opt {
            font-family: 'Orbitron', monospace;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            padding: 5px 14px;
            border-radius: 20px;
            border: 2px solid transparent;
            cursor: default;
            opacity: 0.2;
            transition: all 0.25s;
        }

        .terrain-opt.flat {
            color: #1e7e34;
            border-color: #1e7e34;
        }

        .terrain-opt.smooth {
            color: #b87900;
            border-color: #b87900;
        }

        .terrain-opt.bump {
            color: #c0392b;
            border-color: #c0392b;
        }

        .terrain-opt.active {
            opacity: 1;
            font-weight: 900;
        }

        .terrain-opt.flat.active {
            background: #d4f5db;
        }

        .terrain-opt.smooth.active {
            background: #fdf0cc;
        }

        .terrain-opt.bump.active {
            background: #fde8e6;
        }

        .obs-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 4px;
        }

        .step-badge-large {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.78rem;
            background: var(--black);
            color: var(--yellow);
            padding: 6px 14px;
            border-radius: 8px;
            letter-spacing: 0.08em;
        }

        .timer-mini {
            flex: 1;
            height: 5px;
            background: var(--beige-dark);
            border-radius: 3px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: var(--yellow);
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        .test-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .test-label {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .test-input {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            background: var(--beige);
            border: 2px solid var(--beige-dark);
            border-radius: 10px;
            color: var(--black);
            padding: 12px 14px;
            outline: none;
            transition: border-color 0.2s;
            letter-spacing: 0.12em;
            width: 100%;
        }

        .test-input:focus {
            border-color: var(--yellow-dark);
        }

        .test-input::placeholder {
            color: #c0b8a8;
        }

        .go-btn {
            background: var(--yellow);
            border: none;
            border-radius: 40px;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 1.2rem;
            padding: 16px 48px;
            cursor: pointer;
            color: var(--black);
            letter-spacing: 0.1em;
            transition: all 0.15s;
            box-shadow: 0 4px 20px rgba(245, 200, 0, 0.4);
            align-self: flex-start;
        }

        .go-btn:hover {
            background: var(--yellow-dark);
            transform: translateY(-2px);
        }

        .hint-small {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            color: var(--muted);
            line-height: 1.5;
        }

        .path-log-mini {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .log-chip {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.62rem;
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px solid var(--beige-dark);
            color: var(--muted);
            transition: all 0.2s;
        }

        .log-chip.done {
            background: var(--beige);
            color: var(--black);
            border-color: #ccc5b0;
        }

        .log-chip.current {
            background: var(--yellow);
            color: var(--black);
            border-color: var(--yellow-dark);
            font-weight: 700;
        }

        .err {
            color: #c0392b;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
            display: none;
        }

        /* SAFETY STATUS PANEL */
        .safety-panel {
            background: var(--beige);
            border: 2px solid var(--beige-dark);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 2px;
        }

        .safety-panel-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.14em;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .safety-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .safety-ind {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            padding: 3px 10px;
            border-radius: 12px;
            border: 1.5px solid transparent;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .safety-ind.ok {
            background: #d4f5db;
            border-color: #1e7e34;
            color: #1e7e34;
        }

        .safety-ind.warn {
            background: var(--warn-bg);
            border-color: var(--warn);
            color: var(--warn);
            animation: pulse 1s ease-in-out infinite;
        }

        .safety-ind.danger {
            background: var(--danger-bg);
            border-color: var(--danger);
            color: var(--danger);
            animation: pulse 0.7s ease-in-out infinite;
        }

        /* TRACTION CONFIG */
        .traction-select {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            background: var(--beige);
            border: 2px solid var(--beige-dark);
            border-radius: 8px;
            color: var(--black);
            padding: 6px 10px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
            width: 100%;
        }

        .traction-select:focus {
            border-color: var(--yellow-dark);
        }

        .traction-info {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.64rem;
            color: var(--muted);
            margin-top: 4px;
            line-height: 1.4;
        }

        .traction-info.warn-text {
            color: var(--warn);
        }

        .traction-info.danger-text {
            color: var(--danger);
        }

        /* COMMAND INPUT AREA */
        .cmd-area {
            border: 2px solid var(--beige-dark);
            border-radius: 10px;
            background: var(--beige);
            padding: 10px 12px;
        }

        .cmd-area-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .cmd-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .cmd-input {
            flex: 1;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.9rem;
            background: #fff;
            border: 1.5px solid var(--beige-dark);
            border-radius: 8px;
            color: var(--black);
            padding: 8px 12px;
            outline: none;
            transition: border-color 0.2s;
            letter-spacing: 0.1em;
        }

        .cmd-input:focus {
            border-color: var(--yellow-dark);
        }

        .cmd-mic-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--black);
            border: 2px solid var(--yellow);
            color: var(--yellow);
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .cmd-mic-btn:hover {
            transform: scale(1.1);
        }

        .cmd-mic-btn.listening {
            background: #c0392b;
            border-color: #e74c3c;
            color: #fff;
            animation: pulse 0.8s ease-in-out infinite;
        }

        /* WALL ALERT */
        .wall-alert {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem;
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid var(--danger);
            color: var(--danger);
            background: var(--danger-bg);
            font-weight: 700;
            letter-spacing: 0.05em;
            animation: pulse 0.7s ease-in-out infinite;
        }

        .wall-alert.warn-yellow {
            border-color: var(--warn);
            color: var(--warn);
            background: var(--warn-bg);
        }

        .wall-alert-wrap {
            margin-top: 2px;
            min-height: 22px;
        }

        /* FLOATING MIC BUTTON */
        #mic-fab {
            position: fixed;
            bottom: 28px;
            left: 28px;
            z-index: 999;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--black);
            border: 3px solid var(--yellow);
            color: var(--yellow);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            transition: all 0.2s;
        }

        #mic-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(245, 200, 0, 0.4);
        }

        #mic-fab.listening {
            background: #c0392b;
            border-color: #e74c3c;
            color: #fff;
            animation: pulse 0.8s ease-in-out infinite;
        }

        #mic-status {
            position: fixed;
            bottom: 90px;
            left: 20px;
            z-index: 999;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            background: var(--black);
            color: var(--yellow);
            padding: 4px 10px;
            border-radius: 12px;
            letter-spacing: 0.1em;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #mic-status.show {
            opacity: 1;
        }

        /* EMERGENCY STOP BUTTON */
        #estop-btn {
            position: fixed;
            bottom: 28px;
            right: 28px;
            z-index: 999;
            padding: 12px 22px;
            border-radius: 12px;
            background: var(--danger);
            border: 3px solid #8a1c12;
            color: #fff;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 0.78rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(192, 57, 43, 0.45);
            transition: all 0.15s;
            display: none;
        }

        #estop-btn:hover {
            background: #a93226;
            transform: scale(1.04);
        }

        #estop-btn.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* AQI COLORS */
        .aq-good {
            color: var(--green);
            font-weight: 700;
        }

        .aq-moderate {
            color: #b87900;
            font-weight: 700;
        }

        .aq-poor {
            color: var(--danger);
            font-weight: 700;
        }

        /* CHAT */
        #screen-chat .card {
            width: 780px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            height: 580px;
            max-height: calc(100vh - 60px);
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px 4px;
            border: 1px solid var(--beige-dark);
            border-radius: 12px;
            background: var(--beige);
            margin-bottom: 14px;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 14px;
            font-family: 'Barlow', sans-serif;
            font-size: 0.88rem;
            line-height: 1.5;
            word-break: break-word;
        }

        .chat-bubble.user {
            align-self: flex-end;
            background: var(--yellow);
            color: var(--black);
            border-bottom-right-radius: 4px;
            font-weight: 600;
        }

        .chat-bubble.bot {
            align-self: flex-start;
            background: #fff;
            color: var(--black);
            border: 1px solid var(--beige-dark);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.typing {
            align-self: flex-start;
            background: #fff;
            border: 1px solid var(--beige-dark);
            border-bottom-left-radius: 4px;
            color: var(--muted);
            font-style: italic;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
        }

        .chat-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.9rem;
            background: #fff;
            border: 2px solid var(--beige-dark);
            border-radius: 10px;
            color: var(--black);
            padding: 11px 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--yellow-dark);
        }

        .chat-send-btn {
            background: var(--yellow);
            border: none;
            border-radius: 10px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.78rem;
            padding: 11px 20px;
            cursor: pointer;
            color: var(--black);
            letter-spacing: 0.05em;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .chat-send-btn:hover {
            background: var(--yellow-dark);
        }

        .chat-mic-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--black);
            border: 2px solid var(--yellow);
            color: var(--yellow);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .chat-mic-btn:hover {
            transform: scale(1.08);
        }

        .chat-mic-btn.listening {
            background: #c0392b;
            border-color: #e74c3c;
            color: #fff;
            animation: pulse 0.8s ease-in-out infinite;
        }

        .bot-name {
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: 0.1em;
            margin-bottom: 3px;
        }

        .chat-bubble-wrap {
            display: flex;
            flex-direction: column;
        }

        /* ACTIAN TOGGLE */
        .actian-toggle-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--actian-blue);
            background: #f0f5ff;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #cce0ff;
        }

        .actian-toggle-row input {
            cursor: pointer;
            accent-color: var(--actian-blue);
        }
    </style>
</head>

<body>

    <div class="screen active" id="screen-splash">
        <div class="card">
            <button class="info-btn" title="Info">i</button>
            <div class="splash-pre">John Deere √ó Arduino</div>
            <div class="splash-title">The <span class="accent">Sandozer</span></div>
            <div class="splash-sub">Mission Control</div>
            <div class="actian-badge" style="color: #1976d2; border-color: #1976d2; background: #e3f2fd;">‚ùÑÔ∏è POWERED BY
                SNOWFLAKE</div>
            <div class="splash-divider"></div>
            <div class="splash-about-grid">
                <div class="about-box">
                    <h3>About John Deere</h3>
                    <p>Leading manufacturer of agricultural and construction machinery since 1837. Pioneering autonomous
                        navigation in real-world terrain.</p>
                    <div class="jd-logo">JOHN DEERE</div>
                </div>
                <div class="about-box">
                    <h3>About Our Robot!</h3>
                    <ul>
                        <li>Bulldozer + flat blade</li>
                        <li>Arduino Elegoo Owlbot Tank Kit</li>
                        <li>5√ó5 grid navigation</li>
                        <li>Real-time terrain sensing</li>
                    </ul>
                </div>
            </div>
            <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                <button class="btn-pill" style="padding:14px 40px;" onclick="goTo('screen-mode')">START MISSION
                    ‚Üí</button>
            </div>
        </div>
    </div>

    <div class="screen" id="screen-mode">
        <div class="card">
            <button class="info-btn" onclick="goTo('screen-splash')">‚Üê</button>
            <div style="text-align:center;padding:20px 0 36px;">
                <div class="splash-title" style="font-size:2rem;">The <span class="accent">Sandozer</span></div>
                <div class="splash-sub" style="font-size:0.8rem;">Mission Control</div>
            </div>
            <div class="mode-question">I WANT TO:</div>
            <div class="mode-btns">
                <button class="mode-btn" id="btn-observe" onclick="selectMode('observe')">OBSERVE</button>
                <button class="mode-btn" id="btn-test" onclick="selectMode('test')">TEST</button>
                <button class="mode-btn" id="btn-chat" onclick="selectMode('chat')">CHAT ü§ñ</button>
            </div>
            <div style="text-align:center;">
                <button class="btn-pill" id="mode-continue" onclick="continueMode()"
                    style="opacity:0.4;pointer-events:none;">CONTINUE ‚Üí</button>
            </div>
        </div>
    </div>

    <div class="screen" id="screen-observe">
        <div class="card">
            <div class="card-tag">OBSERVATION</div>
            <div class="screen-title">The Sandozer Traversal</div>
            <div class="observe-layout">

                <div class="mini-grid-wrap">
                    <table class="mini-grid" id="obs-grid"></table>
                    <svg class="mini-svg" id="obs-svg"></svg>
                    <div class="mini-robot" id="obs-robot" style="display:none">
                        <div class="mini-robot-dot pulse">
                            <svg viewBox="0 0 24 24">
                                <rect x="5" y="8" width="14" height="11" rx="2" />
                                <rect x="8" y="4" width="8" height="5" rx="1.5" />
                                <circle cx="9" cy="13" r="1.8" fill="#1a1a1a" />
                                <circle cx="15" cy="13" r="1.8" fill="#1a1a1a" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="obs-panel">

                    <div class="safety-panel">
                        <div class="safety-panel-title">üõ° Safety Status</div>
                        <div class="safety-indicators">
                            <span class="safety-ind ok" id="si-boundary">üìç Boundary: SAFE</span>
                            <span class="safety-ind ok" id="si-tilt">‚Üó Tilt: NORMAL</span>
                            <span class="safety-ind ok" id="si-aq">üí® Air: GOOD</span>
                            <span class="safety-ind ok" id="si-traction">üîß Traction: SET</span>
                        </div>
                    </div>

                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label class="test-label"
                            style="color:var(--danger);font-family:'Orbitron',monospace;font-size:0.68rem;font-weight:700;letter-spacing:0.12em;">‚ö†
                            SAFETY: TRACTION CONFIG</label>
                        <select class="traction-select" id="obs-traction" onchange="updateTractionInfo('obs')">
                            <option value="dry packed/compact sand">üü§ Dry Packed / Compact Sand</option>
                            <option value="dry loose sand">üü° Dry Loose Sand</option>
                            <option value="wet moist sand">üîµ Wet / Moist Sand</option>
                        </select>
                        <div class="traction-info" id="obs-traction-info">Stable surface. Normal speed and turning
                            radius apply.</div>
                    </div>

                    <div class="cmd-area">
                        <div class="cmd-area-title">üì° Path Commands ‚Äî type or speak</div>
                        <div class="cmd-input-row">
                            <input class="cmd-input" id="obs-commands" placeholder="e.g. f f r f l f" />
                            <button class="cmd-mic-btn" id="obs-cmd-mic" onclick="toggleCmdMic()"
                                title="Speak directions">üé§</button>
                            <button class="btn-pill" onclick="startObserveSequence()"
                                style="padding:7px 14px;font-size:0.72rem;border-radius:8px;">‚ñ∂ START</button>
                        </div>
                        <div class="hint-small" style="margin-top:6px;">Commands: <strong>f</strong>=forward &nbsp;
                            <strong>b</strong>=back &nbsp; <strong>l</strong>=left &nbsp;
                            <strong>r</strong>=right<br>Voice: say <em>"forward left right back"</em> ‚Äî auto-submits
                        </div>
                        <div id="obs-cmd-mic-status"
                            style="font-family:'Share Tech Mono',monospace;font-size:0.63rem;color:var(--danger);margin-top:4px;display:none;">
                            üé§ Listening for directions‚Ä¶</div>
                    </div>

                    <div class="obs-row">
                        <span class="obs-label">Position:</span>
                        <span class="obs-val">(<span id="obs-y">0</span>,<span id="obs-x">0</span>)</span>
                    </div>
                    <div class="obs-row">
                        <span class="obs-label">Altitude:</span>
                        <span class="obs-val" id="obs-alt">0.00 m</span>
                    </div>
                    <div class="obs-row">
                        <span class="obs-label">Vertical tilt:</span>
                        <span class="obs-val highlight" id="obs-tilt">0.000¬∞</span>
                    </div>
                    <div class="obs-row">
                        <span class="obs-label">Nearest boundary:</span>
                        <span class="obs-val" id="obs-wall">‚Äî</span>
                    </div>
                    <div class="obs-row">
                        <span class="obs-label">Air Quality (AQI):</span>
                        <span class="obs-val" id="obs-aq">‚Äî</span>
                    </div>

                    <div class="wall-alert-wrap" id="obs-wall-alert-wrap"></div>

                    <div class="obs-row" style="border:none;flex-direction:column;gap:6px;">
                        <span class="obs-label">Terrain:</span>
                        <div class="terrain-row">
                            <span class="terrain-opt flat" id="t-flat">FLAT</span>
                            <span class="terrain-opt smooth" id="t-smooth">SOMEWHAT SMOOTH</span>
                            <span class="terrain-opt bump" id="t-bump">BUMP</span>
                        </div>
                    </div>

                    <div class="obs-controls">
                        <span class="step-badge-large" id="obs-step-badge">STEP 0/0</span>
                        <div class="timer-mini">
                            <div class="timer-fill" id="obs-timer-fill" style="width:100%"></div>
                        </div>
                        <span style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--muted);"
                            id="obs-countdown">0.0s</span>
                        <button class="btn-pill outline" id="obs-pause-btn" onclick="toggleObsPause()"
                            style="padding:6px 16px;font-size:0.7rem;">‚è∏</button>
                    </div>

                    <div style="display:flex;align-items:center;gap:8px;margin-top:2px;">
                        <span class="voice-pill" id="obs-voice-pill">
                            <span class="voice-dot"></span>
                            <span id="obs-voice-label">VOICE IDLE</span>
                        </span>
                    </div>

                    <div class="path-log-mini" id="obs-log"></div>

                    <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn-pill outline" style="padding:8px 20px;font-size:0.72rem;"
                            onclick="goTo('screen-mode')">‚Üê BACK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="screen" id="screen-test">
        <div class="card">
            <div class="card-tag">TEST</div>
            <div class="screen-title">The Sandozer Traversal</div>
            <div class="test-layout">

                <div class="mini-grid-wrap">
                    <table class="mini-grid" id="test-grid"></table>
                    <svg class="mini-svg" id="test-svg"></svg>
                    <div class="mini-robot" id="test-robot" style="display:none">
                        <div class="mini-robot-dot">
                            <svg viewBox="0 0 24 24">
                                <rect x="5" y="8" width="14" height="11" rx="2" />
                                <rect x="8" y="4" width="8" height="5" rx="1.5" />
                                <circle cx="9" cy="13" r="1.8" fill="#1a1a1a" />
                                <circle cx="15" cy="13" r="1.8" fill="#1a1a1a" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="test-panel">

                    <div class="safety-panel">
                        <div class="safety-panel-title">üõ° Safety Status</div>
                        <div class="safety-indicators">
                            <span class="safety-ind ok" id="tsi-boundary">üìç Boundary: SAFE</span>
                            <span class="safety-ind ok" id="tsi-tilt">‚Üó Tilt: NORMAL</span>
                            <span class="safety-ind ok" id="tsi-aq">üí® Air: GOOD</span>
                            <span class="safety-ind ok" id="tsi-traction">üîß Traction: SET</span>
                        </div>
                    </div>

                    <div class="test-input-group">
                        <label class="test-label" style="color:var(--danger);">‚ö† SAFETY: TRACTION CONFIG</label>
                        <select class="traction-select" id="test-traction" onchange="updateTractionInfo('test')">
                            <option value="dry packed/compact sand">üü§ Dry Packed / Compact Sand</option>
                            <option value="dry loose sand">üü° Dry Loose Sand</option>
                            <option value="wet moist sand">üîµ Wet / Moist Sand</option>
                        </select>
                        <div class="traction-info" id="test-traction-info">Stable surface. Normal speed and turning
                            radius apply.</div>
                    </div>

                    <div
                        style="font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:var(--muted);line-height:1.6;background:var(--beige);border-radius:10px;padding:12px 14px;border:1px solid var(--beige-dark);">
                        Enter a target cell. The robot finds the shortest path from <strong
                            style="color:var(--black)">(0,0)</strong> and reports terrain at the destination.
                    </div>

                    <div class="test-input-group">
                        <label class="test-label">Navigate to: (row, col)</label>
                        <input class="test-input" id="test-target" placeholder="e.g. 3,4 ‚Äî or speak two numbers" />
                        <div class="hint-small">Values 0‚Äì4. Robot starts at (0,0) and takes shortest path.<br>üé§ Say two
                            digit numbers (e.g. <em>"two three"</em>) ‚Äî mic auto-activates after greeting.</div>
                        <div class="err" id="test-err">Invalid coordinates. Use row,col (0‚Äì4).</div>
                    </div>

                    <div style="display:flex;align-items:center;gap:16px;">
                        <button class="go-btn" onclick="runTest()">GO!</button>
                        <span class="voice-pill" id="test-voice-pill">
                            <span class="voice-dot"></span>
                            <span id="test-voice-label">VOICE IDLE</span>
                        </span>
                    </div>
                    <div style="margin-top:4px;">
                        <button class="btn-pill outline" style="padding:8px 20px;font-size:0.72rem;"
                            onclick="goTo('screen-mode')">‚Üê BACK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="screen" id="screen-result">
        <div class="card">
            <div class="card-tag">TEST</div>
            <div class="screen-title">The Sandozer Traversal</div>
            <div class="result-layout">

                <div class="mini-grid-wrap">
                    <table class="mini-grid" id="res-grid"></table>
                    <svg class="mini-svg" id="res-svg"></svg>
                    <div class="mini-robot" id="res-robot" style="display:none">
                        <div class="mini-robot-dot">
                            <svg viewBox="0 0 24 24">
                                <rect x="5" y="8" width="14" height="11" rx="2" />
                                <rect x="8" y="4" width="8" height="5" rx="1.5" />
                                <circle cx="9" cy="13" r="1.8" fill="#1a1a1a" />
                                <circle cx="15" cy="13" r="1.8" fill="#1a1a1a" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="result-panel">
                    <div class="result-row"><span class="result-label">Position:</span><span class="result-val"
                            id="res-pos">‚Äî</span></div>
                    <div class="result-row"><span class="result-label">Facing:</span><span class="result-val"
                            id="res-dir">‚Äî</span></div>
                    <div class="result-row"><span class="result-label">Target reached:</span><span class="result-val"
                            id="res-reached">‚Äî</span></div>
                    <div class="result-row"><span class="result-label">Vertical tilt:</span><span
                            class="result-val tilt" id="res-tilt">‚Äî</span></div>
                    <div class="result-row"><span class="result-label">Air Quality:</span><span class="result-val"
                            id="res-aq">‚Äî</span></div>
                    <div class="result-row" style="border:none;flex-direction:column;gap:8px;">
                        <span class="result-label">Terrain:</span>
                        <div class="result-terrain">
                            <span class="terrain-opt flat" id="rt-flat">FLAT</span>
                            <span class="terrain-opt smooth" id="rt-smooth">SOMEWHAT SMOOTH</span>
                            <span class="terrain-opt bump" id="rt-bump">BUMP</span>
                        </div>
                    </div>
                    <div class="path-log-mini" id="res-log" style="max-height:80px;overflow-y:auto;"></div>
                    <div style="margin-top:4px;"><span class="voice-pill" id="res-voice-pill"><span
                                class="voice-dot"></span><span id="res-voice-label">VOICE IDLE</span></span></div>

                    <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;">
                        <button class="btn-pill outline" style="padding:10px 20px;font-size:0.72rem;"
                            onclick="goTo('screen-mode')">‚Üê BACK</button>
                        <button class="btn-pill" style="padding:10px 24px;font-size:0.78rem;"
                            onclick="goTo('screen-test')">TRY AGAIN</button>

                        <button class="btn-pill actian" id="snowflake-save-btn"
                            style="padding:10px 24px;font-size:0.78rem;" onclick="saveMissionToBothDBs()">‚ùÑÔ∏è SAVE TO
                            SNOWFLAKE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="screen" id="screen-chat">
        <div class="card">
            <div class="chat-header">
                <div>
                    <div class="splash-pre" style="margin-bottom:4px;">SANDOZER AI ASSISTANT</div>
                    <div class="screen-title" style="margin-bottom:0;">Ask Me Anything</div>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span class="voice-pill" id="chat-voice-pill"><span class="voice-dot"></span><span
                            id="chat-voice-label">VOICE IDLE</span></span>
                    <button class="btn-pill outline" style="padding:8px 20px;font-size:0.72rem;"
                        onclick="goTo('screen-mode')">‚Üê BACK</button>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="chat-bubble-wrap">
                    <div class="bot-name">SANDOZER AI</div>
                    <div class="chat-bubble bot">üëã Hi! I'm the Sandozer AI assistant. Ask me anything about the
                        Sandozer robot ‚Äî its sensors, navigation, terrain detection, or past missions!</div>
                </div>
            </div>

            <div class="chat-input-row">
                <input class="chat-input" id="chat-input" placeholder="Ask about the Sandozer or past missions..."
                    onkeydown="if(event.key==='Enter')sendChat()" />
                <button class="chat-send-btn" onclick="sendChat()">SEND ‚Üí</button>
                <button class="chat-mic-btn" id="chat-mic-btn" onclick="toggleChatMic()" title="Voice input">üé§</button>
            </div>

            <div class="actian-toggle-row">
                <input type="checkbox" id="use-rag-toggle" checked />
                <label for="use-rag-toggle">‚ùÑÔ∏è Use Snowflake Database (Mission Audit History)</label>
            </div>
        </div>
    </div>

    <button id="mic-fab" onclick="toggleGlobalMic()" title="Voice control">üé§</button>
    <div id="mic-status">LISTENING‚Ä¶</div>
    <button id="estop-btn" onclick="emergencyStop()" title="Emergency Stop">üõë E-STOP</button>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let ELEVEN_VOICE = 'Aa6nEBJJMKJwJkCx8VU2'; // Bella
        let latestMissionData = null; // Store data temporarily to send to DB

        // SNOWFLAKE
        async function saveMissionToBothDBs() {
            const btn = document.getElementById('snowflake-save-btn');
            if (!latestMissionData) return;

            const tractionEl = document.getElementById(currentScreen === 'screen-observe' ? 'obs-traction' : 'test-traction');
            const traction = tractionEl ? tractionEl.value : 'standard';
            const payload = { ...latestMissionData, traction_setting: traction };

            btn.textContent = '‚è≥ SAVING TO BOTH...';
            btn.style.pointerEvents = 'none';

            try {
                // 1. Send to Snowflake (Relational Analytics)
                const snowflakePromise = fetch('/api/snowflake-archive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 2. Send to Cloudflare KV (Chatbot Memory/RAG)
                const kvPromise = fetch('/api/vector-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Wait for both to finish
                const [snowRes, kvRes] = await Promise.all([snowflakePromise, kvPromise]);

                if (!snowRes.ok || !kvRes.ok) throw new Error('One or more saves failed');

                btn.textContent = '‚úÖ SAVED TO SNOWFLAKE & KV';
                btn.style.background = '#d4f5db'; // Success Green
                btn.style.color = '#1e7e34';

            } catch (err) {
                console.error('[Database Error]', err);
                btn.textContent = '‚ö†Ô∏è ERROR SAVING';
                setTimeout(() => {
                    btn.textContent = '‚ùÑÔ∏è SAVE TO BOTH';
                    btn.style.pointerEvents = 'auto';
                }, 3000);
            }
        }
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ACTIAN VECTOR DB INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function saveMissionToVectorDB() {
            const btn = document.getElementById('actian-save-btn');
            if (!latestMissionData) return;

            btn.textContent = '‚è≥ SAVING...';
            btn.style.pointerEvents = 'none';

            try {
                // Here we send the mission stats to the backend to be vectorized and stored
                const res = await fetch('/api/vector-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(latestMissionData)
                });

                if (!res.ok) throw new Error('DB Error');

                btn.textContent = '‚úÖ SAVED TO ACTIAN DB';
                btn.style.background = '#d4f5db';
                btn.style.borderColor = '#1e7e34';
                btn.style.color = '#1e7e34';

            } catch (err) {
                console.error('[Actian DB]', err);
                btn.textContent = '‚ö† ERROR SAVING';
                setTimeout(() => {
                    btn.textContent = 'üíæ SAVE TO ACTIAN VECTOR DB';
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                    btn.style.pointerEvents = 'auto'; // reset styles
                }, 3000);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TRACTION SETTINGS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const TRACTION_INFO = {
            'dry packed/compact sand': {
                info: 'Stable surface. Normal speed and turning radius apply.',
                cls: '',
                speedMult: 1.0,
                safeLabel: 'üîß Traction: SET'
            },
            'dry loose sand': {
                info: '‚ö† Loose surface. Reduce speed 30%. Increased wheel slip risk ‚Äî wide turns recommended.',
                cls: 'warn-text',
                speedMult: 0.7,
                safeLabel: 'üîß Traction: CAUTION'
            },
            'wet moist sand': {
                info: '‚õî Wet surface. Reduce speed 50%. High skid risk ‚Äî avoid sharp turns and slopes.',
                cls: 'danger-text',
                speedMult: 0.5,
                safeLabel: 'üîß Traction: HAZARD'
            }
        };

        function updateTractionInfo(prefix) {
            const sel = document.getElementById(prefix + '-traction');
            const info = document.getElementById(prefix + '-traction-info');
            if (!sel || !info) return;
            const t = TRACTION_INFO[sel.value];
            info.textContent = t.info;
            info.className = 'traction-info' + (t.cls ? ' ' + t.cls : '');

            const siEl = document.getElementById(prefix === 'obs' ? 'si-traction' : 'tsi-traction');
            if (siEl) {
                siEl.textContent = t.safeLabel;
                siEl.className = 'safety-ind ' + (sel.value === 'dry packed/compact sand' ? 'ok' : sel.value === 'dry loose sand' ? 'warn' : 'danger');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ELEVENLABS TTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let audioQueue = [];
        let isSpeaking = false;
        let currentAudio = null;

        function terrainLabel(t) { return t === 'flat' ? 'flat' : t === 'smooth' ? 'somewhat smooth' : 'bumpy'; }

        function buildNarration(step, sensor, idx, total) {
            const terrain = terrainLabel(sensor.terrain);
            if (idx === 0) return 'Sandozer Mission Control online. Beginning sandbox traversal. Starting at position zero zero. All sensors active.';
            if (idx === total - 1) return `Traversal complete. Final position: row ${step.row}, column ${step.col}. Vertical tilt ${sensor.tilt.toFixed(3)} degrees. Terrain is ${terrain}. Air quality index ${sensor.airQuality}. Mission scan finished.`;
            return `Step ${idx} of ${total - 1}. Moving to row ${step.row}, column ${step.col}. Tilt ${sensor.tilt.toFixed(3)} degrees. Terrain: ${terrain}. Air quality: ${sensor.airQuality}.`;
        }

        async function speak(text, pillId, labelId, onComplete) {
            audioQueue.push({ text, pillId, labelId, onComplete });
            if (!isSpeaking) drainQueue();
        }

        async function drainQueue() {
            if (!audioQueue.length) { isSpeaking = false; return; }
            isSpeaking = true;
            const { text, pillId, labelId, onComplete } = audioQueue.shift();
            setVoicePill(pillId, labelId, true);

            try {
                const res = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voiceId: ELEVEN_VOICE })
                });
                if (!res.ok) throw new Error('TTS error ' + res.status);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                currentAudio = new Audio(url);
                currentAudio.onended = () => {
                    URL.revokeObjectURL(url);
                    setVoicePill(pillId, labelId, false);
                    currentAudio = null;
                    drainQueue();
                    if (!audioQueue.length && onComplete) setTimeout(onComplete, 150);
                };
                currentAudio.onerror = () => {
                    setVoicePill(pillId, labelId, false);
                    currentAudio = null;
                    drainQueue();
                };
                await currentAudio.play();
            } catch (e) {
                console.warn('[TTS]', e.message);
                setVoicePill(pillId, labelId, false);
                currentAudio = null;
                drainQueue();
                if (onComplete) setTimeout(onComplete, 150);
            }
        }

        function setVoicePill(pillId, labelId, active) {
            const pill = document.getElementById(pillId);
            const label = document.getElementById(labelId);
            if (!pill || !label) return;
            pill.classList.toggle('active', active);
            label.textContent = active ? 'SPEAKING‚Ä¶' : 'VOICE IDLE';
        }

        function stopAllAudio() {
            audioQueue = [];
            isSpeaking = false;
            if (currentAudio) { currentAudio.pause(); currentAudio.src = ''; currentAudio = null; }
            ['obs-voice-pill', 'test-voice-pill', 'res-voice-pill', 'chat-voice-pill'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            ['obs-voice-label', 'test-voice-label', 'res-voice-label', 'chat-voice-label'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'VOICE IDLE';
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EMERGENCY STOP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function emergencyStop() {
            clearInterval(obsTimer);
            obsPaused = true;
            stopAllAudio();
            const pauseBtn = document.getElementById('obs-pause-btn');
            if (pauseBtn) pauseBtn.textContent = '‚ñ∂';
            const pillId = currentScreen === 'screen-test' ? 'test-voice-pill' : 'obs-voice-pill';
            const labelId = currentScreen === 'screen-test' ? 'test-voice-label' : 'obs-voice-label';
            speak('Emergency stop activated. Robot halted. All movement suspended.', pillId, labelId);
        }

        function showEStop(show) {
            const btn = document.getElementById('estop-btn');
            btn.className = show ? 'active' : '';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WALL PROXIMITY SAFETY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CELL_SIZE_M = 0.20;
        let lastWallZone = -1;

        function checkWallProximity(row, col, stepIdx) {
            const wallDist = Math.min(row, col, 4 - row, 4 - col);
            const wrap = document.getElementById('obs-wall-alert-wrap');
            const screenPfx = (currentScreen === 'screen-observe') ? 'si' : 'tsi';
            const siEl = document.getElementById(screenPfx + '-boundary');

            if (stepIdx === 0) {
                lastWallZone = wallDist;
                if (wrap) wrap.innerHTML = '';
                if (siEl) { siEl.textContent = 'üìç Boundary: SAFE'; siEl.className = 'safety-ind ok'; }
                return;
            }

            const pillId = (currentScreen === 'screen-observe') ? 'obs-voice-pill' : 'test-voice-pill';
            const labelId = (currentScreen === 'screen-observe') ? 'obs-voice-label' : 'test-voice-label';
            const zoneChanged = wallDist !== lastWallZone;
            lastWallZone = wallDist;

            if (wallDist === 0) {
                if (wrap) wrap.innerHTML = `<span class="wall-alert">‚õî AT BOUNDARY</span>`;
                if (siEl) { siEl.textContent = 'üìç Boundary: AT WALL'; siEl.className = 'safety-ind danger'; }
                if (zoneChanged) speak('Warning. Robot is at the boundary.', pillId, labelId);
            } else if (wallDist === 1) {
                if (wrap) wrap.innerHTML = `<span class="wall-alert">‚ö† APPROACHING BOUNDARY</span>`;
                if (siEl) { siEl.textContent = 'üìç Boundary: WARNING'; siEl.className = 'safety-ind danger'; }
                if (zoneChanged) speak('Approaching boundary.', pillId, labelId);
            } else if (wallDist === 2) {
                if (wrap) wrap.innerHTML = `<span class="wall-alert warn-yellow">‚ö† NEAR BOUNDARY</span>`;
                if (siEl) { siEl.textContent = 'üìç Boundary: CAUTION'; siEl.className = 'safety-ind warn'; }
            } else {
                if (wrap) wrap.innerHTML = '';
                if (siEl) { siEl.textContent = 'üìç Boundary: SAFE'; siEl.className = 'safety-ind ok'; }
            }
        }

        function checkAQSafety(aq, prefix, pillId, labelId, stepIdx) {
            const siEl = document.getElementById(prefix + '-aq');
            if (!siEl) return;
            if (aq > 150) {
                siEl.textContent = 'üí® Air: DANGEROUS';
                siEl.className = 'safety-ind danger';
                if (stepIdx !== undefined && stepIdx % 3 === 0) {
                    speak(`Air quality alert. AQI is ${aq}. Conditions are hazardous. Recommend halting operations.`, pillId, labelId);
                }
            } else if (aq > 100) {
                siEl.textContent = 'üí® Air: MODERATE';
                siEl.className = 'safety-ind warn';
            } else {
                siEl.textContent = 'üí® Air: GOOD';
                siEl.className = 'safety-ind ok';
            }
        }

        function checkTiltSafety(tilt, terrain, prefix) {
            const siEl = document.getElementById(prefix + '-tilt');
            if (!siEl) return;
            if (terrain === 'bump') {
                siEl.textContent = '‚Üó Tilt: HIGH RISK';
                siEl.className = 'safety-ind danger';
            } else if (terrain === 'smooth') {
                siEl.textContent = '‚Üó Tilt: ELEVATED';
                siEl.className = 'safety-ind warn';
            } else {
                siEl.textContent = '‚Üó Tilt: NORMAL';
                siEl.className = 'safety-ind ok';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NAVIGATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function goTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;

            showEStop(screenId === 'screen-observe' || screenId === 'screen-test');

            if (screenId !== 'screen-observe') stopAllAudio();
            if (screenId === 'screen-observe') initObserve();

            if (screenId === 'screen-test') {
                initTestGrid();
                updateTractionInfo('test');
                speak(
                    'Hello! What position would you like to navigate to? Say two numbers for row and column, each between 0 and 4.',
                    'test-voice-pill', 'test-voice-label',
                    () => { if (currentScreen === 'screen-test') { continuousListen = true; startGlobalMic(); } }
                );
            }
            if (screenId === 'screen-chat') initChat();
            updateMicContext(screenId);
        }

        let selectedMode = null;
        function selectMode(mode) {
            selectedMode = mode;
            document.getElementById('btn-observe').classList.toggle('selected', mode === 'observe');
            document.getElementById('btn-test').classList.toggle('selected', mode === 'test');
            document.getElementById('btn-chat').classList.toggle('selected', mode === 'chat');
            const cont = document.getElementById('mode-continue');
            cont.style.opacity = '1'; cont.style.pointerEvents = 'auto';
        }
        function continueMode() {
            if (!selectedMode) return;
            const dest = selectedMode === 'observe' ? 'screen-observe' : selectedMode === 'test' ? 'screen-test' : 'screen-chat';
            goTo(dest);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRID BUILDER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CELL = 44, GAP = 3;
        function buildMiniGrid(tableEl) {
            tableEl.innerHTML = '';
            const cells = [];
            for (let r = 0; r < 5; r++) {
                cells[r] = [];
                const tr = document.createElement('tr');
                for (let c = 0; c < 5; c++) {
                    const td = document.createElement('td');
                    td.className = 'mini-cell';
                    td.innerHTML = `<span class="mc-label">${r},${c}</span>`;
                    tr.appendChild(td); cells[r][c] = td;
                }
                tableEl.appendChild(tr);
            }
            return cells;
        }

        function cellCenter(row, col) { return { x: 3 + 6 + col * (CELL + 3) + CELL / 2, y: 3 + 6 + row * (CELL + 3) + CELL / 2 }; }
        function gridTotalSize() { return (3 + 6) + 5 * (CELL + 3); }

        const DIRS = ['E', 'S', 'W', 'N'];
        const DELTA = { E: [0, 1], S: [1, 0], W: [0, -1], N: [-1, 0] };
        const DIR_LABEL = { E: 'East ‚Üí', S: 'South ‚Üì', W: 'West ‚Üê', N: 'North ‚Üë' };

        function parseCommands(text) {
            const tokens = text.toLowerCase().match(/[fblr]/g);
            if (!tokens || !tokens.length) return null;
            const path = [];
            let row = 0, col = 0, di = 0;
            path.push({ row, col, dir: DIRS[di], cmd: 'START' });
            for (const cmd of tokens) {
                if (cmd === 'l') { di = (di + 3) % 4; path.push({ row, col, dir: DIRS[di], cmd: 'L' }); }
                else if (cmd === 'r') { di = (di + 1) % 4; path.push({ row, col, dir: DIRS[di], cmd: 'R' }); }
                else {
                    const [dr, dc] = DELTA[DIRS[di]];
                    row = Math.max(0, Math.min(4, row + (cmd === 'f' ? dr : -dr)));
                    col = Math.max(0, Math.min(4, col + (cmd === 'f' ? dc : -dc)));
                    path.push({ row, col, dir: DIRS[di], cmd: cmd === 'f' ? 'F' : 'B' });
                }
            }
            return path;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SENSOR DATA
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const TILT_MAP = (() => {
            const m = [];
            for (let r = 0; r < 5; r++) { m[r] = []; for (let c = 0; c < 5; c++) m[r][c] = Math.round(Math.random() * 300) / 1000; }
            m[0][0] = Math.round(Math.random() * 49) / 1000;
            return m;
        })();

        const ALTITUDE_MAP = (() => {
            const m = [];
            for (let r = 0; r < 5; r++) { m[r] = []; for (let c = 0; c < 5; c++) m[r][c] = Math.round(Math.random() * 150) / 1000; }
            return m;
        })();

        const AIR_QUALITY_MAP = (() => {
            const m = [];
            for (let r = 0; r < 5; r++) { m[r] = []; for (let c = 0; c < 5; c++) m[r][c] = Math.round((40 + Math.random() * 160) / 5) * 5; }
            return m;
        })();

        function tiltToTerrain(t) { return t < 0.05 ? 'flat' : t <= 0.15 ? 'smooth' : 'bump'; }

        function getSensorData(row, col) {
            const tilt = TILT_MAP[row][col];
            const terrain = tiltToTerrain(tilt);
            const alt = ALTITUDE_MAP[row][col];
            const wallDist = Math.min(row, col, 4 - row, 4 - col);
            const airQuality = AIR_QUALITY_MAP[row][col];
            return { tilt, terrain, alt, wallDist, airQuality };
        }

        function drawPath(svgEl, steps, upTo) {
            const sz = gridTotalSize();
            svgEl.setAttribute('viewBox', `0 0 ${sz} ${sz}`);
            svgEl.setAttribute('width', sz); svgEl.setAttribute('height', sz);
            svgEl.innerHTML = '';
            if (upTo < 1) return;
            const pts = [];
            for (let i = 0; i <= upTo; i++) {
                const { x, y } = cellCenter(steps[i].row, steps[i].col);
                if (!pts.length || pts[pts.length - 1].x !== x || pts[pts.length - 1].y !== y) pts.push({ x, y });
            }
            if (pts.length < 2) return;
            const ptStr = pts.map(p => `${p.x},${p.y}`).join(' ');
            svgEl.appendChild(makePoly(ptStr, '#b0a890', 11));
            svgEl.appendChild(makePoly(ptStr, '#1a1a1a', 7));
            const dash = makePoly(ptStr, '#f5c800', 2);
            dash.setAttribute('stroke-dasharray', '6 8');
            svgEl.appendChild(dash);
            const seen = new Set();
            for (let i = 0; i <= upTo; i++) {
                const { row, col } = steps[i], key = `${row},${col}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    const { x, y } = cellCenter(row, col);
                    const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    c.setAttribute('cx', x); c.setAttribute('cy', y); c.setAttribute('r', i === 0 ? 5 : 4);
                    c.setAttribute('fill', i === 0 ? '#f5c800' : '#1a1a1a');
                    c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width', '1.5');
                    svgEl.appendChild(c);
                }
            }
        }

        function makePoly(pts, stroke, width) {
            const el = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            el.setAttribute('points', pts); el.setAttribute('stroke', stroke);
            el.setAttribute('stroke-width', width); el.setAttribute('stroke-linecap', 'round');
            el.setAttribute('stroke-linejoin', 'round'); el.setAttribute('fill', 'none');
            return el;
        }

        function moveRobot(robotEl, row, col) {
            const { x, y } = cellCenter(row, col);
            robotEl.style.left = x + 'px'; robotEl.style.top = y + 'px'; robotEl.style.display = 'block';
        }

        function setTerrainHighlight(prefix, terrain) {
            ['flat', 'smooth', 'bump'].forEach(t =>
                document.getElementById(prefix + t).classList.toggle('active', terrain === t)
            );
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // OBSERVE SCREEN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let obsSteps = [], obsStep = 0, obsPaused = false, obsTimer = null, obsElapsed = 0;
        const OBS_INTERVAL = 10000;

        function initObserve() {
            clearInterval(obsTimer);
            stopAllAudio();
            lastWallZone = -1;
            obsStep = 0;
            obsPaused = false;

            buildMiniGrid(document.getElementById('obs-grid'));
            const sz = gridTotalSize();
            const svg = document.getElementById('obs-svg');
            svg.setAttribute('width', sz); svg.setAttribute('height', sz);
            svg.innerHTML = '';
            document.getElementById('obs-robot').style.display = 'none';
            document.getElementById('obs-log').innerHTML = '';
            document.getElementById('obs-wall-alert-wrap').innerHTML = '';

            updateTractionInfo('obs');

            speak('Observation mode ready. Please select a traction setting, enter path commands, and press Start.', 'obs-voice-pill', 'obs-voice-label', () => {
                if (currentScreen === 'screen-observe') { continuousListen = true; startGlobalMic(); }
            });
        }

        function startObserveSequence() {
            let cmds = document.getElementById('obs-commands').value.trim().replace('üé§ ', '');
            if (!cmds) cmds = 'f f f r f f';

            obsSteps = parseCommands(cmds) || [{ row: 0, col: 0, dir: 'E', cmd: 'START' }];
            obsStep = 0;
            obsPaused = false;
            lastWallZone = -1;

            buildMiniGrid(document.getElementById('obs-grid'));
            buildObsLog();

            const traction = document.getElementById('obs-traction').value;
            const tractionT = TRACTION_INFO[traction];
            let safetyMsg = `Commencing patrol. Safety traction mechanism optimized for ${traction}.`;
            if (traction === 'wet moist sand') safetyMsg += ' High slip risk active. Reduced speed applied.';
            else if (traction === 'dry loose sand') safetyMsg += ' Caution: loose terrain. Reduced speed applied.';

            speak(safetyMsg, 'obs-voice-pill', 'obs-voice-label');
            renderObsStep(0);
            startObsTimer();
        }

        function buildObsLog() {
            const log = document.getElementById('obs-log');
            log.innerHTML = '';
            obsSteps.forEach((s, i) => {
                const chip = document.createElement('span');
                chip.className = 'log-chip' + (i === 0 ? ' current' : '');
                chip.textContent = `(${s.row},${s.col})`;
                log.appendChild(chip);
            });
        }

        function renderObsStep(idx) {
            const s = obsSteps[idx];
            if (!s) return;
            const sensor = getSensorData(s.row, s.col);

            moveRobot(document.getElementById('obs-robot'), s.row, s.col);
            drawPath(document.getElementById('obs-svg'), obsSteps, idx);

            document.getElementById('obs-x').textContent = s.col;
            document.getElementById('obs-y').textContent = s.row;
            document.getElementById('obs-alt').textContent = sensor.alt.toFixed(2) + ' m';

            const tiltEl = document.getElementById('obs-tilt');
            tiltEl.textContent = sensor.tilt.toFixed(3) + '¬∞';
            tiltEl.style.color = sensor.terrain === 'flat' ? 'var(--green)' : sensor.terrain === 'smooth' ? '#b87900' : '#c0392b';

            document.getElementById('obs-wall').textContent = sensor.wallDist + ' cell' + (sensor.wallDist !== 1 ? 's' : '');
            document.getElementById('obs-step-badge').textContent = `STEP ${idx}/${obsSteps.length - 1}`;

            const aqEl = document.getElementById('obs-aq');
            const aq = sensor.airQuality;
            aqEl.textContent = aq + ' AQI ‚Äî ' + (aq <= 100 ? 'Good' : aq <= 150 ? 'Moderate' : 'Poor');
            aqEl.className = 'obs-val ' + (aq <= 100 ? 'aq-good' : aq <= 150 ? 'aq-moderate' : 'aq-poor');

            setTerrainHighlight('t-', sensor.terrain);
            checkTiltSafety(sensor.tilt, sensor.terrain, 'si');
            checkAQSafety(aq, 'si', 'obs-voice-pill', 'obs-voice-label', idx);

            document.querySelectorAll('#obs-log .log-chip').forEach((el, i) => {
                el.className = 'log-chip' + (i < idx ? ' done' : i === idx ? ' current' : '');
            });
            const cur = document.querySelector('#obs-log .current');
            if (cur) cur.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            checkWallProximity(s.row, s.col, idx);
            const text = buildNarration(s, sensor, idx, obsSteps.length);
            speak(text, 'obs-voice-pill', 'obs-voice-label');

            // Auto trigger result screen when done
            if (idx === obsSteps.length - 1) {
                setTimeout(() => showResult(obsSteps, s.row, s.col), 900);
            }
        }

        function startObsTimer() {
            clearInterval(obsTimer);
            obsElapsed = 0; updateObsTimerUI();
            obsTimer = setInterval(() => {
                if (obsPaused) return;
                obsElapsed += 100;
                updateObsTimerUI();
                if (obsElapsed >= OBS_INTERVAL) {
                    obsElapsed = 0;
                    if (obsStep < obsSteps.length - 1) { obsStep++; renderObsStep(obsStep); }
                    else { clearInterval(obsTimer); document.getElementById('obs-timer-fill').style.width = '0%'; }
                }
            }, 100);
        }

        function updateObsTimerUI() {
            const rem = Math.max(0, OBS_INTERVAL - obsElapsed);
            document.getElementById('obs-timer-fill').style.width = ((rem / OBS_INTERVAL) * 100) + '%';
            document.getElementById('obs-countdown').textContent = (rem / 1000).toFixed(1) + 's';
        }

        function toggleObsPause() {
            obsPaused = !obsPaused;
            document.getElementById('obs-pause-btn').textContent = obsPaused ? '‚ñ∂' : '‚è∏';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BFS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function bfsPath(tr, tc) {
            if (tr === 0 && tc === 0) return [{ row: 0, col: 0 }];
            const visited = Array.from({ length: 5 }, () => Array(5).fill(false));
            const parent = Array.from({ length: 5 }, () => Array(5).fill(null));
            const q = [{ row: 0, col: 0 }]; visited[0][0] = true;
            const dirs = [[0, 1], [1, 0], [0, -1], [-1, 0]];
            while (q.length) {
                const { row, col } = q.shift();
                if (row === tr && col === tc) {
                    const path = []; let cur = { row, col };
                    while (cur) { path.unshift(cur); cur = parent[cur.row][cur.col]; }
                    return path;
                }
                for (const [dr, dc] of dirs) {
                    const nr = row + dr, nc = col + dc;
                    if (nr >= 0 && nr < 5 && nc >= 0 && nc < 5 && !visited[nr][nc]) { visited[nr][nc] = true; parent[nr][nc] = { row, col }; q.push({ row: nr, col: nc }); }
                }
            }
            return [{ row: 0, col: 0 }];
        }

        function bfsToSteps(cellPath) {
            return cellPath.map((p, i) => ({ row: p.row, col: p.col, dir: 'E', cmd: i === 0 ? 'START' : 'F' }));
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TEST SCREEN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function initTestGrid() {
            buildMiniGrid(document.getElementById('test-grid'));
            const sz = gridTotalSize();
            const svg = document.getElementById('test-svg');
            svg.setAttribute('width', sz); svg.setAttribute('height', sz);
            svg.innerHTML = '';
            document.getElementById('test-robot').style.display = 'none';
            moveRobot(document.getElementById('test-robot'), 0, 0);
        }

        function runTest() {
            const targetText = document.getElementById('test-target').value.trim();
            const err = document.getElementById('test-err');
            const m = targetText.match(/(\d)\s*,\s*(\d)/);
            if (!m || +m[1] > 4 || +m[2] > 4) {
                err.style.display = 'block';
                err.textContent = 'Invalid target. Use row,col with values 0‚Äì4.';
                setTimeout(() => err.style.display = 'none', 3000);
                return;
            }
            const targetRow = +m[1], targetCol = +m[2];
            const traction = document.getElementById('test-traction').value;
            speak(`Commencing test traversal to row ${targetRow}, column ${targetCol}. Traction optimized for ${traction}.`, 'test-voice-pill', 'test-voice-label');
            animateTest(bfsToSteps(bfsPath(targetRow, targetCol)), targetRow, targetCol);
        }

        function animateTest(steps, targetRow, targetCol) {
            buildMiniGrid(document.getElementById('test-grid'));
            const sz = gridTotalSize();
            const svg = document.getElementById('test-svg');
            svg.setAttribute('width', sz); svg.setAttribute('height', sz);
            svg.innerHTML = '';
            const robot = document.getElementById('test-robot');
            let i = 0;
            lastWallZone = -1;

            function next() {
                drawPath(svg, steps, i);
                moveRobot(robot, steps[i].row, steps[i].col);
                const sensor = getSensorData(steps[i].row, steps[i].col);
                checkWallProximity(steps[i].row, steps[i].col, i);
                checkTiltSafety(sensor.tilt, sensor.terrain, 'tsi');
                checkAQSafety(sensor.airQuality, 'tsi', 'test-voice-pill', 'test-voice-label', i);
                if (i < steps.length - 1) { i++; setTimeout(next, 700); }
                else { setTimeout(() => showResult(steps, targetRow, targetCol), 900); }
            }
            next();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RESULT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showResult(steps, targetRow, targetCol) {
            const last = steps[steps.length - 1];
            const sensor = getSensorData(last.row, last.col);

            // SAVE STATE FOR DB
            latestMissionData = {
                mission_type: targetRow ? 'Test Navigation' : 'Observation Patrol',
                end_position: [last.row, last.col],
                terrain_classification: sensor.terrain,
                tilt_degrees: sensor.tilt,
                air_quality_aqi: sensor.airQuality,
                path_taken: steps.map(s => `[${s.row},${s.col}]`).join(' -> '),
                timestamp: new Date().toISOString()
            };

            // Reset DB button state
            const btn = document.getElementById('actian-save-btn');
            if (btn) {
                btn.textContent = 'üíæ SAVE TO ACTIAN VECTOR DB';
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.color = ''; // reset color
                btn.style.pointerEvents = 'auto';
            }

            goTo('screen-result');

            buildMiniGrid(document.getElementById('res-grid'));
            const sz = gridTotalSize();
            const resSvg = document.getElementById('res-svg');
            resSvg.setAttribute('width', sz); resSvg.setAttribute('height', sz);
            drawPath(resSvg, steps, steps.length - 1);
            moveRobot(document.getElementById('res-robot'), last.row, last.col);

            document.getElementById('res-pos').textContent = `(${last.row}, ${last.col})`;
            document.getElementById('res-dir').textContent = DIR_LABEL[last.dir];

            const reached = last.row === targetRow && last.col === targetCol;
            const reachEl = document.getElementById('res-reached');

            if (targetRow === undefined) {
                reachEl.textContent = '‚úì Patrol Finished';
                reachEl.style.color = 'var(--green)';
            } else {
                reachEl.textContent = reached ? '‚úì YES ‚Äî destination reached!' : `‚úó NO ‚Äî ended at (${last.row},${last.col})`;
                reachEl.style.color = reached ? 'var(--green)' : 'var(--danger)';
            }

            const tiltEl = document.getElementById('res-tilt');
            tiltEl.textContent = sensor.tilt.toFixed(3) + '¬∞';
            tiltEl.style.color = sensor.terrain === 'flat' ? 'var(--green)' : sensor.terrain === 'smooth' ? '#b87900' : 'var(--danger)';

            const resAqEl = document.getElementById('res-aq');
            const aq = sensor.airQuality;
            const aqStatus = aq <= 100 ? 'Safe' : aq <= 150 ? 'Medium' : 'Dangerous';
            resAqEl.textContent = aq + ' AQI ‚Äî ' + aqStatus;
            resAqEl.className = 'result-val ' + (aq <= 100 ? 'aq-good' : aq <= 150 ? 'aq-moderate' : 'aq-poor');

            setTerrainHighlight('rt-', sensor.terrain);

            const resLog = document.getElementById('res-log');
            resLog.innerHTML = '';
            steps.forEach((s, i) => {
                const chip = document.createElement('span');
                chip.className = 'log-chip done';
                chip.textContent = i === 0 ? `START(${s.row},${s.col})` : `‚Üí(${s.row},${s.col})`;
                resLog.appendChild(chip);
            });

            const terrain = terrainLabel(sensor.terrain);
            const terrainDetail = sensor.terrain === 'flat' ? 'No leveling required.' : sensor.terrain === 'smooth' ? 'Moderate leveling recommended.' : 'High priority for leveling.';
            const narration = (reached || targetRow === undefined)
                ? `Mission complete. Destination reached at row ${last.row}, column ${last.col}. Vertical tilt is ${sensor.tilt.toFixed(3)} degrees. Terrain is ${terrain}. ${terrainDetail} Air quality index is ${sensor.airQuality}.`
                : `Mission ended at row ${last.row}, column ${last.col}. Target was not reached. Terrain is ${terrain}. Air quality index is ${sensor.airQuality}.`;
            speak(narration, 'res-voice-pill', 'res-voice-label');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GEMINI CHATBOT + ACTIAN RAG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const SANDOZER_SYSTEM = `You are the Sandozer AI assistant ‚Äî an expert on the Sandozer robot built for the UIUC Hackathon in partnership with John Deere.

Here are key facts about the Sandozer robot:
- Hardware: Arduino Elegoo Owlbot Tank Kit with a bulldozer-style flat blade attachment
- Purpose: Autonomous sandbox terrain leveling
- Navigation: 5√ó5 grid, BFS shortest-path navigation
- Sensors: MPU-6050 IMU (tilt), HC-SR04 ultrasonic (wall detection), air quality sensor, altitude sensor
- Terrain: Flat (<0.05¬∞), Somewhat Smooth (0.05‚Äì0.15¬∞), Bumpy (>0.15¬∞)
- Safety: Boundary alerts ‚â§2 grid cells from any wall.
- Traction Config: Dry Packed (normal), Dry Loose (‚àí30% speed, slip risk), Wet Moist (‚àí50% speed, skid risk)
- Database: Uses Snowflake to store mission logs and telemetry.

Answer questions concisely in 2‚Äì4 sentences.`;

        let chatHistory = [];
        function initChat() { chatHistory = []; }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';

            appendChatBubble(msg, 'user');
            chatHistory.push({ role: 'user', parts: [{ text: msg }] });

            const useRag = document.getElementById('use-rag-toggle').checked;
            let typingMsg = useRag ? 'üîç Querying Actian Vector DB...' : 'Thinking‚Ä¶';
            const typingEl = appendChatBubble(typingMsg, 'typing');

            try {
                let contextAddendum = "";

                // 1. If RAG is enabled, hit the VectorDB proxy first!
                if (useRag) {
                    try {
                        const ragRes = await fetch('/api/vector-search', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: msg })
                        });

                        if (ragRes.ok) {
                            const ragData = await ragRes.json();
                            if (ragData.context) {
                                contextAddendum = `\n\n[ACTIAN VECTOR DB CONTEXT RETRIEVED]: ${ragData.context}`;
                            }
                        }
                    } catch (e) {
                        console.warn('Actian Vector DB not yet connected on backend.', e);
                    }
                }

                // 2. Add context to prompt and send to Gemini
                const systemPrompt = SANDOZER_SYSTEM + contextAddendum;

                const requestBody = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: chatHistory,
                    generationConfig: { maxOutputTokens: 300, temperature: 0.7 }
                };

                typingEl.textContent = 'üß† Analyzing context...';

                const res = await fetch('/api/gemini', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                const data = await res.json();

                if (!res.ok || data.error) throw new Error(data.error?.message || 'API Error');

                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response received.';

                chatHistory.push({ role: 'model', parts: [{ text: reply }] });
                typingEl.className = 'chat-bubble bot';
                typingEl.textContent = reply;

                document.getElementById('chat-messages').scrollTop = 99999;
                speak(reply, 'chat-voice-pill', 'chat-voice-label');

            } catch (e) {
                typingEl.className = 'chat-bubble bot';
                typingEl.textContent = '‚ö† ' + e.message;
            }
        }

        function appendChatBubble(text, type) {
            const msgs = document.getElementById('chat-messages');
            const wrap = document.createElement('div');
            wrap.className = 'chat-bubble-wrap';
            if (type === 'bot' || type === 'typing') {
                const name = document.createElement('div');
                name.className = 'bot-name'; name.textContent = 'SANDOZER AI'; wrap.appendChild(name);
            }
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type}`; bubble.textContent = text;
            wrap.appendChild(bubble); msgs.appendChild(wrap);
            msgs.scrollTop = msgs.scrollHeight;
            return bubble;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMMAND MIC (Observe directions only)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let cmdMicActive = false;
        let cmdMicRecognition = null;

        function toggleCmdMic() {
            if (cmdMicActive) stopCmdMic();
            else startCmdMic();
        }

        function startCmdMic() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { alert('Web Speech not supported. Use Chrome.'); return; }
            cmdMicRecognition = new SR();
            cmdMicRecognition.lang = 'en-US';
            cmdMicRecognition.interimResults = false;
            cmdMicRecognition.onstart = () => {
                cmdMicActive = true;
                document.getElementById('obs-cmd-mic').classList.add('listening');
                document.getElementById('obs-cmd-mic-status').style.display = 'block';
            };
            cmdMicRecognition.onresult = (e) => {
                const raw = e.results[0][0].transcript.toLowerCase().trim();
                const normalized = normalizeDirections(raw);
                if (normalized.length > 0) {
                    document.getElementById('obs-commands').value = normalized;
                    setTimeout(startObserveSequence, 400);
                }
            };
            cmdMicRecognition.onend = () => {
                cmdMicActive = false;
                document.getElementById('obs-cmd-mic').classList.remove('listening');
                document.getElementById('obs-cmd-mic-status').style.display = 'none';
            };
            cmdMicRecognition.onerror = () => {
                cmdMicActive = false;
                document.getElementById('obs-cmd-mic').classList.remove('listening');
                document.getElementById('obs-cmd-mic-status').style.display = 'none';
            };
            cmdMicRecognition.start();
        }

        function stopCmdMic() {
            if (cmdMicRecognition) { try { cmdMicRecognition.stop(); } catch (e) { } }
            cmdMicActive = false;
            document.getElementById('obs-cmd-mic').classList.remove('listening');
            document.getElementById('obs-cmd-mic-status').style.display = 'none';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WEB SPEECH ‚Äî GLOBAL MIC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let globalRecognition = null;
        let chatRecognition = null;
        let globalMicActive = false;
        let chatMicActive = false;
        let currentScreen = 'screen-splash';
        let continuousListen = false;

        function normalizeNumbers(t) {
            return t.replace(/\bzero\b/g, '0').replace(/\bone\b/g, '1').replace(/\b(two|too)\b/g, '2').replace(/\bthree\b/g, '3').replace(/\b(four)\b/g, '4').replace(/\boh\b/g, '0');
        }

        function normalizeDirections(t) {
            return t.toLowerCase()
                .replace(/\b(forward|straight)\b/g, 'f ')
                .replace(/\bback(ward)?\b/g, 'b ')
                .replace(/\bleft\b/g, 'l ')
                .replace(/\bright\b/g, 'r ')
                .replace(/[^fblr\s]/g, '')
                .replace(/\s+/g, ' ').trim();
        }

        function parseTestCoords(transcript) {
            const t = normalizeNumbers(transcript.toLowerCase());
            let m = t.match(/row\s*(\d).*?col(?:umn)?\s*(\d)/); if (m) return m;
            m = t.match(/(?:navigate|go)\s+to\s+(\d)\D*(\d)/); if (m) return m;
            m = t.match(/(\d)\s*[,.]\s*(\d)/); if (m) return m;
            const digits = [...t.matchAll(/\b(\d)\b/g)];
            if (digits.length >= 2) return [null, digits[0][1], digits[1][1]];
            return null;
        }

        function updateMicContext(screenId) {
            currentScreen = screenId;
            if (screenId !== 'screen-test' && screenId !== 'screen-observe') { continuousListen = false; stopGlobalMic(); }
        }

        function buildSpeechRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return null;
            const rec = new SR(); rec.lang = 'en-US'; rec.interimResults = false; rec.maxAlternatives = 3;
            return rec;
        }

        function toggleGlobalMic() {
            if (globalMicActive) { continuousListen = false; stopGlobalMic(); } else startGlobalMic();
        }

        function startGlobalMic() {
            if (globalMicActive) return;
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { alert('Web Speech API not supported. Please use Chrome.'); return; }
            globalRecognition = buildSpeechRecognition();
            globalRecognition.onstart = () => {
                globalMicActive = true;
                document.getElementById('mic-fab').classList.add('listening');
                document.getElementById('mic-status').classList.add('show');
            };
            globalRecognition.onresult = (e) => {
                const transcripts = Array.from(e.results[0]).map(alt => alt.transcript.toLowerCase().trim());
                if (currentScreen === 'screen-test') document.getElementById('test-target').value = 'üé§ ' + transcripts[0];
                else if (currentScreen === 'screen-observe') document.getElementById('obs-commands').value = 'üé§ ' + transcripts[0];
                for (const t of transcripts) { if (handleVoiceCommand(t)) break; }
            };
            globalRecognition.onend = () => {
                globalMicActive = false;
                if (continuousListen && (currentScreen === 'screen-test' || currentScreen === 'screen-observe') && !isSpeaking) {
                    setTimeout(() => { if (continuousListen) startGlobalMic(); }, 350);
                } else {
                    document.getElementById('mic-fab').classList.remove('listening');
                    document.getElementById('mic-status').classList.remove('show');
                }
            };
            globalRecognition.onerror = (e) => {
                globalMicActive = false;
                if (continuousListen && e.error !== 'not-allowed' && e.error !== 'service-unavailable') {
                    setTimeout(() => { if (continuousListen) startGlobalMic(); }, 500);
                } else {
                    document.getElementById('mic-fab').classList.remove('listening');
                    document.getElementById('mic-status').classList.remove('show');
                }
            };
            globalRecognition.start();
        }

        function stopGlobalMic() {
            continuousListen = false;
            if (globalRecognition) { try { globalRecognition.stop(); } catch (e) { } }
            globalMicActive = false;
            document.getElementById('mic-fab').classList.remove('listening');
            document.getElementById('mic-status').classList.remove('show');
        }

        function handleVoiceCommand(transcript) {
            const screen = currentScreen;

            if (/\b(emergency stop|stop now|halt|e.?stop)\b/.test(transcript) && (screen === 'screen-observe' || screen === 'screen-test')) {
                emergencyStop(); return true;
            }

            if (/\b(back|go back|menu|home)\b/.test(transcript) && screen !== 'screen-splash' && screen !== 'screen-mode') {
                goTo('screen-mode'); return true;
            }

            if (screen === 'screen-splash') {
                if (/\b(start|begin|launch|go|continue)\b/.test(transcript)) { goTo('screen-mode'); return true; }

            } else if (screen === 'screen-mode') {
                if (/\bobserv/.test(transcript)) { selectMode('observe'); continueMode(); return true; }
                if (/\btest\b/.test(transcript)) { selectMode('test'); continueMode(); return true; }
                if (/\bchat\b/.test(transcript)) { selectMode('chat'); continueMode(); return true; }
                if (/\b(continue|proceed|go|confirm|next|enter)\b/.test(transcript)) { continueMode(); return true; }

            } else if (screen === 'screen-test') {
                if (/\b(cancel)\b/.test(transcript)) { continuousListen = false; goTo('screen-mode'); return true; }
                const m = parseTestCoords(transcript);
                if (m) {
                    const r = +m[1], c = +m[2];
                    if (r <= 4 && c <= 4) {
                        continuousListen = false; stopGlobalMic();
                        document.getElementById('test-target').value = `${r},${c}`;
                        setTimeout(() => runTest(), 400);
                        return true;
                    }
                }
                return false;

            } else if (screen === 'screen-observe') {
                if (/\b(pause|stop|freeze)\b/.test(transcript)) { toggleObsPause(); return true; }
                if (/\b(resume|play|continue|unpause)\b/.test(transcript)) { if (obsPaused) toggleObsPause(); return true; }
                if (/\b(next|skip)\b/.test(transcript)) {
                    if (obsStep < obsSteps.length - 1) { obsStep++; obsElapsed = 0; renderObsStep(obsStep); }
                    return true;
                }
                if (/\b(start|begin|go|patrol)\b/.test(transcript)) { startObserveSequence(); return true; }
                const parsedDirs = normalizeDirections(transcript);
                if (parsedDirs.length > 0) {
                    document.getElementById('obs-commands').value = parsedDirs;
                    continuousListen = false; stopGlobalMic();
                    setTimeout(startObserveSequence, 500);
                    return true;
                }

            } else if (screen === 'screen-result') {
                if (/\b(again|retry|repeat|redo)\b/.test(transcript)) { goTo('screen-test'); return true; }

            } else if (screen === 'screen-chat') {
                if (!/\b(back|menu|home)\b/.test(transcript)) {
                    document.getElementById('chat-input').value = transcript;
                    sendChat(); return true;
                }
            }
            return false;
        }

        function toggleChatMic() { if (chatMicActive) stopChatMic(); else startChatMic(); }

        function startChatMic() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return;
            chatRecognition = buildSpeechRecognition();
            chatRecognition.onstart = () => { chatMicActive = true; document.getElementById('chat-mic-btn').classList.add('listening'); };
            chatRecognition.onresult = (e) => {
                document.getElementById('chat-input').value = e.results[0][0].transcript.trim();
                sendChat();
            };
            chatRecognition.onend = () => { chatMicActive = false; document.getElementById('chat-mic-btn').classList.remove('listening'); };
            chatRecognition.onerror = () => { chatMicActive = false; document.getElementById('chat-mic-btn').classList.remove('listening'); };
            chatRecognition.start();
        }

        function stopChatMic() {
            if (chatRecognition) { try { chatRecognition.stop(); } catch (e) { } }
            chatMicActive = false;
            document.getElementById('chat-mic-btn').classList.remove('listening');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.addEventListener('load', () => {
            ['obs-grid', 'test-grid', 'res-grid'].forEach(id => buildMiniGrid(document.getElementById(id)));
            const sz = gridTotalSize();
            ['obs-svg', 'test-svg', 'res-svg'].forEach(id => {
                const el = document.getElementById(id);
                el.setAttribute('width', sz); el.setAttribute('height', sz);
            });
            updateTractionInfo('obs');
            updateTractionInfo('test');
        });
    </script>
</body>

</html>